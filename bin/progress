#!/usr/bin/env node
var terminal = require('node-terminal');
var carrier = require('carrier');
var argv = require('optimist')
  .usage('Usage: $0 -f [field index]')
  .argv;

var lines = {};
var top = 0;
var keyFieldIndex = argv.f || 'a';
var nowrap = '[?7l';
var wrap = '[?7h';

process.stdin.resume();
carrier.carry(process.stdin).on('line', function(line) {
    var text = line+"";
    var splitText = text.split(" ");

    if (keyFieldIndex=='a') {
      var firstField = splitText[0];
      if (firstField=="bower") {
        keyFieldIndex=1;
      } else
      if (firstField=="npm") {
        keyFieldIndex=3;
      } else {
        keyFieldIndex=1;
      }
    }

    var key = text.split(" ")[keyFieldIndex];
    var moveUp = 0;

    terminal.write(nowrap);

    // remove control characters - notably clear screen
    line = line.replace(/[\x00-\x1f]/g,'');

    if (lines[ key ] != undefined) {
      // already have this line
      moveUp = top-lines[ key ];
      terminal.up(moveUp);
      terminal.clearLine();
      terminal.write(line);
      terminal.nl();
      if (moveUp>1) {
        terminal.down(moveUp-1);
      }
    }
    else {
      // don't have this line yet
      lines[ key ] = top;
      top += 1;
      terminal.write(line);
      terminal.nl();
    }

    terminal.write(wrap);
});
