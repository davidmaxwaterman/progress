#!/usr/bin/env node
var terminal = require('node-terminal');
var carrier = require('carrier');

var lines = {};
var top = 0;
var keyFieldNo = process.argv[2] || 1;
var nowrap = '[?7l';
var wrap = '[?7h';

process.stdin.resume();
carrier.carry(process.stdin).on('line', function(line) {
    var text = line+"";
    var key = text.split(" ")[keyFieldNo];
    var moveUp = 0;

    terminal.write(nowrap);

    // remove control characters - notably clear screen
    line = line.replace(/[\x00-\x1f]/g,'');

    if (lines[ key ] != undefined) {
      // already have this line
      moveUp = top-lines[ key ];
      terminal.up(moveUp);
      terminal.clearLine();
      terminal.write(line);
      terminal.nl();
      if (moveUp>1) {
        terminal.down(moveUp-1);
      }
    }
    else {
      // don't have this line yet
      lines[ key ] = top;
      top += 1;
      terminal.write(line);
      terminal.nl();
    }

    terminal.write(wrap);
});
